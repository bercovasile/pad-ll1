# Pgpool-II Configuration File - READ to Replicas, WRITE to Master

# Connection Settings
listen_addresses = '*'
port = 5432
socket_dir = '/var/run/pgpool'

# PCP (Pgpool Control Protocol)
pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/var/run/pgpool'

# ============================================
# Backend PostgreSQL Nodes
# ============================================
backend_hostname0 = 'pg-master'
backend_port0 = 5432
backend_weight0 = 1           # SCHIMBAT: participă la load balancing
backend_data_directory0 = '/var/lib/postgresql/data'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_application_name0 = 'pg-master'

backend_hostname1 = 'pg-slave-1'
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = '/var/lib/postgresql/data'
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_application_name1 = 'pg-slave-1'

backend_hostname2 = 'pg-slave-2'
backend_port2 = 5432
backend_weight2 = 1
backend_data_directory2 = '/var/lib/postgresql/data'
backend_flag2 = 'ALLOW_TO_FAILOVER'
backend_application_name2 = 'pg-slave-2'

# ============================================
# Authentication
# ============================================
enable_pool_hba = off
pool_passwd = ''
authentication_timeout = 120              # MĂRIT
allow_clear_text_frontend_auth = on

# ============================================
# Health Check - CRITIC PENTRU FAILOVER
# ============================================
health_check_period = 10                  # Verificare la fiecare 10s
health_check_timeout = 20                 # MĂRIT: timeout 20s
health_check_user = 'postgres'
health_check_password = 'postgres'
health_check_database = 'postgres'
health_check_max_retries = 5              # MĂRIT: mai multe încercări
health_check_retry_delay = 2              # MĂRIT: pauză între încercări
connect_timeout = 30000                   # MĂRIT: 30s

# ============================================
# Streaming Replication Check
# ============================================
sr_check_period = 10                      # Verificare la fiecare 10s
sr_check_user = 'postgres'
sr_check_password = 'postgres'
sr_check_database = 'postgres'
delay_threshold = 10000000

# ============================================
# Failover Settings - ACTIVAT PENTRU HA
# ============================================
failover_on_backend_error = on            # ACTIVAT: failover automat
failover_command = ''                     # Patroni se ocupă de failover
failback_command = ''
failover_on_backend_shutdown = on         # ACTIVAT: failover la shutdown
detach_false_primary = on                 # ACTIVAT: detașează false primary
search_primary_node_timeout = 60          # REDUS: caută primary mai rapid

# ============================================
# Auto Failback (când master revine)
# ============================================
auto_failback = off                       # NU reattach automat master-ul vechi
auto_failback_interval = 60

# ============================================
# Backend Status
# ============================================
follow_primary_command = ''               # Patroni gestionează follow

# ============================================
# LOAD BALANCING
# ============================================
load_balance_mode = on
ignore_leading_white_space = on

# Direcționează toate WRITE către primary (orice slave devine primary)
write_function_list = 'nextval,setval,currval,lastval'
read_only_function_list = ''

# În tranzacții cu WRITE, rămâi pe primary
disable_load_balance_on_write = 'transaction'
statement_level_load_balance = on

# ============================================
# MASTER/SLAVE MODE
# ============================================
master_slave_mode = on
master_slave_sub_mode = 'stream'
backend_clustering_mode = 'streaming_replication'

# ============================================
# Connection Settings
# ============================================
connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'

# ============================================
# Logs - pentru debugging
# ============================================
log_destination = 'stderr'
log_line_prefix = '%t: pid %p: '
log_connections = on
log_hostname = on
log_statement = on
log_per_node_statement = on
log_client_messages = on
log_standby_delay = 'if_over_threshold'